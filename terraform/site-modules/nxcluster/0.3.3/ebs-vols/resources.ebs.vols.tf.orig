########################################################
##
##  ARBITRARY SET OF EBS VOLUMES
##

##  THIS IS THE MAGIC HACK THAT GETS THE INDEXED VOLUME ID ELEMENT
##  OUT OF EACH EBS VOLUME ID LIST AND ALLOWS THAT LIST TO BE INSERTED
##  INTO THE INSTANCE USER DATA SCRIPT
##
##  TO ADD AN EBS VOLUME:
##    1. COPY A MODULE INSTANTIATION STANZA BELOW
##    2. MODIFY AS REQUIRED - USE A NEW, UNIQUE NAME
##    3. ADD A REFERENCE TO THE NEW MODULE / EBS VOLUME
##       IN THE DATA FILE TEMPLATE LIST BELOW
##
data "template_file" "all_ebs_volume_detail_id_lists" {
  count = "${var.instance_count}"

  template = "${
    join(
      ";",
      list(
        "${element(module.data_volume.volume_details_ids_list, count.index)}",
        "${element(module.logs_volume.volume_details_ids_list, count.index)}"
      )
    )
  }"
}

module "data_volume" {
  ##  TF PARAMETERS - SHOULD BE THE SAME FOR EACH EBS VOLUME MODULE INVOCATION
  source       = "git::ssh://git@cgit01.bitpusher.com/bp-tools/bitpusher-terraform-modules//ec2/ebs.vol.attach/0.1.3"
  count        = "${var.instance_count}"
  name         = "${var.name}"
  instance_ids = "${var.instance_ids}"
  az_list      = "${list(element(var.az_list,0))}"
  org          = "${var.env_strings["org"]}"
  env          = "${var.env_strings["env"]}"
  tags         = "${var.tags}"

  ##  VOLUME PARAMETERS - PASSED TO INSTANCES VIA USER DATA
  vol_name    = "data"
  ebs_type    = "gp2"
  iops        = 0
  snapshot_id = ""
  size        = 5
  encrypted   = true
  device_id   = "/dev/sdh"  ##  IGNORED FOR NVME VOLUMES, BUT MUST BE LIKE "/dev/sdh"
  vol_label   = "data"
  fs_type     = "ext4"
  mount_point = "/mnt/data"
}

##  LOGS VOLUME
module "logs_volume" {
  source       = "git::ssh://git@cgit01.bitpusher.com/bp-tools/bitpusher-terraform-modules//ec2/ebs.vol.attach/0.1.3"
  count        = "${var.instance_count}"
  name         = "${var.name}"
  instance_ids = "${var.instance_ids}"
  az_list      = "${list(element(var.az_list,0))}"
  org          = "${var.env_strings["org"]}"
  env          = "${var.env_strings["env"]}"
  tags         = "${var.tags}"
  vol_name     = "logs"
  ebs_type     = "io1"
  iops         = 100                                                                                                  ##  REQUIRED FOR TYPE IO1
  snapshot_id  = ""
  size         = 10
  encrypted    = false
  device_id    = "/dev/sdi"
  vol_label    = "logs"
  fs_type      = "ext4"
  mount_point  = "/mnt/logs"
}

output "all_ebs_volume_detail_id_lists" {
  value = "${data.template_file.all_ebs_volume_detail_id_lists.*.rendered}"
}
